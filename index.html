<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Running Story Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://js.puter.com/v2/"></script>

  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #312e81 0%, #6d28d9 50%, #db2777 100%);
      margin: 0;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    }

    .container {
      max-width: 820px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, .2);
      padding: 2rem 1.5rem;
      margin-bottom: 2rem;
    }

    h1,
    h2 {
      color: #fff;
      font-weight: bold;
      margin: 0 0 1rem 0;
    }

    .genre-select,
    select {
      width: 100%;
      padding: .75rem;
      background: rgba(255, 255, 255, 0.15);
      border-radius: .75rem;
      border: 2px solid rgba(255, 255, 255, 0.25);
      color: #fff;
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    label {
      color: #fff;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: .5rem;
      display: block;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .stat {
      background: rgba(255, 255, 255, 0.15);
      padding: 1rem;
      border-radius: .75rem;
      color: #fff;
      text-align: left;
    }

    .stat-title {
      color: #cbd5e1;
      font-size: .95rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
    }

    .status {
      text-align: center;
      color: #cbd5e1;
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    button {
      background: #10b981;
      color: #fff;
      font-weight: 600;
      padding: .75rem 1.5rem;
      border-radius: .75rem;
      font-size: 1rem;
      border: none;
      cursor: pointer;
      transition: background .2s;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    button.pause {
      background: #f59e42;
    }

    button.reset {
      background: #ef4444;
    }

    button.tts-on {
      background: #22c55e;
    }

    button.tts-off {
      background: #ef4444;
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .progress {
      width: 100%;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 1rem;
      height: 1.1rem;
      margin-bottom: .5rem;
      position: relative;
    }

    .progress-bar {
      background: linear-gradient(90deg, #fde68a 0%, #db2777 100%);
      height: 100%;
      border-radius: 1rem;
      transition: width .4s;
    }

    .story-card {
      background: rgba(255, 255, 255, 0.15);
      border-radius: .75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      color: #fff;
    }

    .story-segment-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .95rem;
      margin-bottom: .5rem;
      color: #fde68a;
      font-weight: bold;
    }

    .story-segment-body {
      color: #fff;
      white-space: pre-line;
      font-size: 1.07rem;
      margin-bottom: .25rem;
      line-height: 1.5;
    }

    .setup {
      background: rgba(59, 130, 246, 0.14);
      border: 1px solid rgba(59, 130, 246, 0.22);
      border-radius: .75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      color: #fff;
      font-size: .95rem;
    }

    .notification-status {
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .bell-enabled {
      color: #22c55e;
    }

    .bell-disabled {
      color: #fff;
      opacity: .5;
    }

    .audio-btn {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 1.1rem;
      margin-left: .5rem;
      padding: 0 .25rem;
    }

    .audio-btn:hover {
      color: #fde68a;
    }

    .small-text {
      color: #cbd5e1;
      font-size: .85rem;
    }

    .animate-pulse {
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 1
      }

      50% {
        opacity: .5
      }

      100% {
        opacity: 1
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div style="display:flex;align-items:center;gap:.7rem;margin-bottom:1.3rem;">
        <span style="font-size:2.3rem; color: #fde68a;">üìñ</span>
        <h1>Running Story Tracker</h1>
      </div>
      <div id="setup-panel"></div>
      <div class="stats">
        <div class="stat">
          <div class="stat-title">Distance</div>
          <div class="stat-value" id="distance-display">0.000 mi</div>
        </div>
        <div class="stat">
          <div class="stat-title">Speed</div>
          <div class="stat-value" id="speed-display">0.0 mph</div>
        </div>
      </div>
      <div class="status" id="gps-status">Ready</div>
      <div style="text-align:center; margin-bottom: 1.2rem;">
        <button id="tts-toggle" class="tts-on">
          <span id="tts-icon">üîä</span>
          <span id="tts-label">Audio Narration ON</span>
        </button>
      </div>
      <div id="segment-progress-panel"></div>
      <div class="controls">
        <button id="start-btn"><span id="play-icon">‚ñ∂Ô∏è</span> <span id="start-label">Start Running</span></button>
        <button id="pause-btn" class="pause" style="display:none;"><span>‚è∏</span> Pause</button>
        <button id="reset-btn" class="reset"><span>‚ü≤</span> Reset</button>
      </div>
      <div id="generating-indicator" style="text-align:center; color:#fde68a; margin-top:1rem; display:none;"
        class="animate-pulse">‚ú® Generating your story segment...</div>
    </div>
    <div id="story-panel"></div>
  </div>
  <script>
    // State variables
    const genres = [
      'Fantasy Adventure',
      'Sci-Fi Thriller',
      'Mystery Detective',
      'Horror Survival',
      'Romance Comedy',
      'Historical Fiction',
      'Superhero Action',
      'Dystopian Future'
    ];
    let genre = '';
    let isTracking = false;
    let distance = 0;
    let speed = 0;
    let storySegments = [];
    let isGenerating = false;
    let lastStoryDistance = 0;
    let hasStarted = false;
    let gpsStatus = 'Ready';
    let isTTSEnabled = true;
    let isSpeaking = false;
    let notificationsEnabled = false;

    let watchId = null;
    let lastPosition = null;
    let lastTime = null;
    let totalDistance = 0;
    let speedHistory = [];

    let currentAudio = null;
    var storyText;
    // DOM references
    var lines

    const setupPanel = document.getElementById('setup-panel');
    const distanceDisplay = document.getElementById('distance-display');
    const speedDisplay = document.getElementById('speed-display');
    const gpsStatusDisplay = document.getElementById('gps-status');
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resetBtn = document.getElementById('reset-btn');
    const ttsToggleBtn = document.getElementById('tts-toggle');
    const ttsIcon = document.getElementById('tts-icon');
    const ttsLabel = document.getElementById('tts-label');
    const segmentProgressPanel = document.getElementById('segment-progress-panel');
    const generatingIndicator = document.getElementById('generating-indicator');
    const storyPanel = document.getElementById('story-panel');
    const startLabel = document.getElementById('start-label');

    // Notification permission
    if ('Notification' in window) {
      notificationsEnabled = Notification.permission === 'granted';
    }

    function renderSetupPanel() {
      if (hasStarted) {
        setupPanel.innerHTML = '';
        return;
      }
      setupPanel.innerHTML = `
        <label>Choose Your Story Genre:</label>
        <select id="genre-select" class="genre-select">
          <option value="">Select a genre...</option>
          ${genres.map(g => `<option value="${g}">${g}</option>`).join('')}
        </select>
        <div class="setup">
          <div class="notification-status">
            ${notificationsEnabled
          ? '<span class="bell-enabled">üîî</span>'
          : '<span class="bell-disabled">üîï</span>'
        }
            <span>Story Notifications</span>
            ${!notificationsEnabled
          ? `<button id="enable-notifications" style="background:#3b82f6;color:#fff;padding:.3rem .8rem;border-radius:.4rem;border:none; font-size:.95rem;">Enable</button>`
          : '<span style="color:#34d399;font-size:.95rem;">‚úì Enabled</span>'
        }
          </div>
          <p class="small-text" style="margin-top:.5rem;">Location permission will be requested when you start running</p>
        </div>
      `;
      document.getElementById('genre-select').value = genre;
      document.getElementById('genre-select').onchange = e => {
        genre = e.target.value;
      };
      if (!notificationsEnabled && document.getElementById('enable-notifications')) {
        document.getElementById('enable-notifications').onclick = async () => {
          if ('Notification' in window) {
            const permission = await Notification.requestPermission();
            notificationsEnabled = permission === 'granted';
            if (permission === 'granted') {
              new Notification('üéâ Notifications Enabled!', {
                body: "You'll be notified when new story segments are ready."
              });
            }
            renderSetupPanel();
          } else {
            alert('Notifications are not supported in this browser');
          }
        };
      }
    }

    function renderSegmentProgress() {
      if (!hasStarted) {
        segmentProgressPanel.innerHTML = '';
        return;
      }
      const distanceSinceLastStory = totalDistance - lastStoryDistance;
      const progressToNextSegment = ((distanceSinceLastStory) / 0.5) * 100;
      segmentProgressPanel.innerHTML = `
        <div style="display:flex;justify-content:space-between;color:#fff;font-size:.95rem;margin-bottom:.2rem;">
          <span>Next Story Segment</span>
          <span>${Math.max(0, Math.min(progressToNextSegment, 100)).toFixed(0)}%</span>
        </div>
        <div class="progress">
          <div class="progress-bar" style="width:${Math.min(progressToNextSegment, 100)}%;"></div>
        </div>
        <div class="small-text" style="text-align:center;margin-top:.4rem;">
          ${(0.5 - (distance - lastStoryDistance)).toFixed(3)} miles to next segment
        </div>
      `;
    }

    function renderStats() {
      distanceDisplay.textContent = `${distance.toFixed(3)} mi`;
      speedDisplay.textContent = `${speed.toFixed(1)} mph`;
      gpsStatusDisplay.textContent = gpsStatus + (isSpeaking ? ' üîä Speaking...' : '');
    }

    function renderControls() {
      if (!isTracking) {
        startBtn.style.display = '';
        pauseBtn.style.display = 'none';
        startLabel.textContent = hasStarted ? 'Resume' : 'Start Running';
      } else {
        startBtn.style.display = 'none';
        pauseBtn.style.display = '';
      }
    }

    function renderTTSButton() {
      ttsToggleBtn.className = isTTSEnabled ? 'tts-on' : 'tts-off';
      ttsIcon.textContent = isTTSEnabled ? 'üîä' : 'üîà';
      ttsLabel.textContent = isTTSEnabled ? 'Audio Narration ON' : 'Audio Narration OFF';
    }

    function renderStoryPanel() {
      if (!genre || !storySegments.length) {
        storyPanel.innerHTML = '';
        return;
      }
      storyPanel.innerHTML = `
        <div class="card">
          <h2>Your ${genre} Story</h2>
          <div>
            ${storySegments.map(segment => `
              <div class="story-card">
                <div class="story-segment-head">
                  <span>Segment ${segment.segment}</span>
                  <div>
                    <button class="audio-btn" onclick="window.playStoryAudio(${segment.segment})" title="Play audio">üîä</button>
                    <span style="color:#cbd5e1;font-size:.94rem;">
                      ${segment.speed.toFixed(1)} mph ‚Ä¢ ${segment.timestamp}
                    </span>
                  </div>
                </div>
                <div class="story-segment-body">${segment.text}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderGeneratingIndicator() {
      generatingIndicator.style.display = isGenerating ? '' : 'none';
    }

    function renderAll() {
      renderSetupPanel();
      renderStats();
      renderControls();
      renderTTSButton();
      renderSegmentProgress();
      renderStoryPanel();
      renderGeneratingIndicator();
    }

    // Audio playback for story segments
    window.playStoryAudio = function (segmentNum) {
      const segment = storySegments.find(s => s.segment === segmentNum);
      if (segment) speakText(segment.text);
    };
    // TTS toggle
    ttsToggleBtn.onclick = () => {
      isTTSEnabled = !isTTSEnabled;
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
        isSpeaking = false;
      }
      window.speechSynthesis.cancel();
      renderAll();
    };

    // Start tracking
    startBtn.onclick = () => {
      if (!genre) {
        alert('Please select a genre first!');
        return;
      }
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
      }
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
          notificationsEnabled = permission === 'granted';
          renderSetupPanel();
        });
      }
      hasStarted = true;
      isTracking = true;
      gpsStatus = 'Requesting location permission...';
      lastTime = Date.now();
      navigator.geolocation.getCurrentPosition(
        (position) => {
          lastPosition = {
            lat: position.coords.latitude,
            lon: position.coords.longitude
          };
          lastTime = Date.now();
          gpsStatus = 'GPS Locked';
          watchId = navigator.geolocation.watchPosition(
            handlePositionUpdate,
            handlePositionError,
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
          renderAll();
        },
        (error) => {
          handlePositionError(error);
          isTracking = false;
          hasStarted = false;
          renderAll();
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
      renderAll();
    };

    // Pause tracking
    pauseBtn.onclick = () => {
      isTracking = false;
      gpsStatus = 'Paused';
      stopSpeaking();
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      renderAll();
    };

    // Reset app
    resetBtn.onclick = () => {
      isTracking = false;
      hasStarted = false;
      gpsStatus = 'Ready';
      distance = 0;
      speed = 0;
      storySegments = [];
      lastStoryDistance = 0;
      lastPosition = null;
      lastTime = null;
      totalDistance = 0;
      speedHistory = [];
      stopSpeaking();
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      renderAll();
    };

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3958.8;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function handlePositionUpdate(position) {
      const currentTime = Date.now();
      const currentLat = position.coords.latitude;
      const currentLon = position.coords.longitude;
      const accuracy = position.coords.accuracy;
      gpsStatus = `GPS Active (¬±${accuracy.toFixed(0)}m)`;
      if (lastPosition && lastTime) {
        const dist = calculateDistance(
          lastPosition.lat, lastPosition.lon,
          currentLat, currentLon
        );
        const timeDiffHours = (currentTime - lastTime) / 1000 / 3600;
        if (dist > 0.001 && dist < 0.5 && timeDiffHours > 0) {
          totalDistance += dist;
          distance = totalDistance;
          const currentSpeed = dist / timeDiffHours;
          if (currentSpeed > 0 && currentSpeed < 25) {
            speedHistory.push(currentSpeed);
            if (speedHistory.length > 10) speedHistory.shift();
            const avgSpeed = speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length;
            speed = avgSpeed;
          }
        }
      }
      lastPosition = { lat: currentLat, lon: currentLon };
      lastTime = currentTime;
      renderAll();
      triggerStorySegmentIfNeeded();
    }

    function handlePositionError(error) {
      console.error("GPS Error:", error);
      if (error.code === 1) {
        gpsStatus = 'Location permission denied';
        alert('Please enable location permissions in your browser settings to track your run.');
      } else if (error.code === 2) {
        gpsStatus = 'GPS signal unavailable';
      } else if (error.code === 3) {
        gpsStatus = 'GPS timeout - trying again...';
      }
      renderAll();
    }

    function triggerStorySegmentIfNeeded() {
      const distanceSinceLastStory = totalDistance - lastStoryDistance;
      if (isTracking && distanceSinceLastStory >= 0.5 && !isGenerating) {
        const segmentNumber = Math.floor(totalDistance / 0.5);
        const avgSpeed = speedHistory.length > 0
          ? speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length
          : 3;
        generateStorySegment(segmentNumber, avgSpeed);
        lastStoryDistance = totalDistance;
        renderAll();
      }
    }

    async function generateStorySegment(segmentNumber, avgSpeed) {
    isGenerating = true;
    renderAll();
    const paceDescription = avgSpeed > 4 ? 'fast-paced and intense'
      : avgSpeed > 3 ? 'moderate tension'
        : 'reflective and atmospheric';
    const prevSummary = storySegments.slice(-2).map(s => s.text.slice(0, 100)).join(' ... ');
    const prompt = `You are writing segment ${segmentNumber} of an ongoing ${genre} story. This is a story for a runner, and they've been running at ${avgSpeed.toFixed(1)} mph, so make this segment ${paceDescription}.
${segmentNumber === 1
      ? `This is the BEGINNING of the story. Introduce the main character and setting in an engaging way. End with a hook that makes them want to keep running for the next part. Write 7-8 paragraphs.`
      : `This is segment ${segmentNumber}. Continue the story with rising action. Reference what happened before naturally. End with a cliffhanger or exciting moment. Write 7-8 paragraphs.
Previous segments summary: ${prevSummary}`
    }
Write ONLY the story segment, no meta-commentary. Make it exciting and match the running pace!`;

    // Use DeepSeek via OpenRouter for story generation
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer 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`, // <-- put your free key here!
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "deepseek-ai/deepseek-llm-7b-base",
        messages: [{content:prompt}],
        max_tokens: 512
      })
    });
    const data = await response.json();
    console.log(data)
    const storyText = data.choices[0].message.content;
    const newSegment = {
      segment: segmentNumber,
      text: storyText,
      speed: avgSpeed,
      timestamp: new Date().toLocaleTimeString()
    };
    storySegments.push(newSegment);

    // Auto-play TTS if enabled and tracking
    if (isTTSEnabled && isTracking) {
      speakText(storyText);
    }

    isGenerating = false;
    renderAll();
  }

  // Keep Puter TTS for speech
  async function speakText(text) {
    stopSpeaking();
    isSpeaking = true;
    renderAll();
    // Puter TTS API
    puter.ai.txt2speech(text, {voice: "Arthur", engine: "neural"}).then(audio => { audio.play() })
    renderAll();
  }

  function stopSpeaking() {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio = null;
    }
    window.speechSynthesis.cancel();
    isSpeaking = false;
    renderAll();
  }

    // Initial render
    renderAll();
  </script>
</body>

</html>