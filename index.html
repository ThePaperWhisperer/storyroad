<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Story Tracker</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
    }

    .card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
    }

    .header h1 {
        color: white;
        font-size: 28px;
    }

    .icon {
        font-size: 32px;
    }

    .genre-select {
        width: 100%;
        padding: 15px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        font-size: 16px;
        margin-bottom: 20px;
    }

    .genre-select option {
        background: #764ba2;
        color: white;
    }

    .stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-box {
        background: rgba(255, 255, 255, 0.2);
        padding: 20px;
        border-radius: 10px;
    }

    .stat-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
        margin-bottom: 5px;
    }

    .stat-value {
        color: white;
        font-size: 32px;
        font-weight: bold;
    }

    .progress-container {
        margin-bottom: 20px;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        color: white;
        font-size: 14px;
        margin-bottom: 10px;
    }

    .progress-bar {
        width: 100%;
        height: 16px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ffd700 0%, #ff69b4 100%);
        transition: width 0.5s;
    }

    .buttons {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .btn {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: transform 0.2s;
    }

    .btn:active {
        transform: scale(0.95);
    }

    .btn-start {
        background: #10b981;
        color: white;
    }

    .btn-pause {
        background: #f59e0b;
        color: white;
    }

    .btn-reset {
        background: #ef4444;
        color: white;
    }

    .btn-audio {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .status {
        text-align: center;
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
        margin-bottom: 15px;
    }

    .status-highlight {
        color: #ffd700;
        margin-left: 10px;
    }

    .permissions-box {
        background: rgba(59, 130, 246, 0.2);
        border: 2px solid rgba(59, 130, 246, 0.3);
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }

    .permissions-box h3 {
        color: white;
        margin-bottom: 15px;
    }

    .permission-item {
        display: flex;
        align-items: center;
        gap: 10px;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 10px;
    }

    .story-segments {
        margin-top: 20px;
    }

    .story-segment {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
    }

    .segment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .segment-title {
        color: #ffd700;
        font-weight: bold;
    }

    .segment-meta {
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .segment-text {
        color: white;
        line-height: 1.6;
        white-space: pre-line;
    }

    .speaker-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        font-size: 18px;
        padding: 5px;
    }

    .speaker-btn:hover {
        color: white;
    }

    .generating {
        text-align: center;
        color: #ffd700;
        margin-top: 20px;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    label {
        display: block;
        color: white;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 10px;
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <span class="icon">üìö</span>
                <h1>Running Story Tracker</h1>
            </div>

```
        <div id="setupSection">
            <label>Choose Your Story Genre:</label>
            <select id="genreSelect" class="genre-select">
                <option value="">Select a genre...</option>
                <option value="Fantasy Adventure">Fantasy Adventure</option>
                <option value="Sci-Fi Thriller">Sci-Fi Thriller</option>
                <option value="Mystery Detective">Mystery Detective</option>
                <option value="Horror Survival">Horror Survival</option>
                <option value="Romance Comedy">Romance Comedy</option>
                <option value="Historical Fiction">Historical Fiction</option>
                <option value="Superhero Action">Superhero Action</option>
                <option value="Dystopian Future">Dystopian Future</option>
            </select>

            <div class="permissions-box">
                <h3>üìã Permissions Needed:</h3>
                <div class="permission-item">
                    <span id="locationIcon">üìç</span>
                    <span>Location tracking for distance</span>
                </div>
                <div class="permission-item">
                    <span id="notificationIcon">üîî</span>
                    <span>Notifications for new story segments</span>
                </div>
                <button id="enableNotificationsBtn" class="btn btn-audio" style="margin-top: 15px;">
                    Enable Notifications
                </button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">Distance</div>
                <div class="stat-value" id="distanceDisplay">0.000 mi</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Speed</div>
                <div class="stat-value" id="speedDisplay">0.0 mph</div>
            </div>
        </div>

        <div class="status">
            Status: <span id="gpsStatus">Ready</span>
            <span id="speakingStatus" style="display: none;" class="status-highlight">üîä Speaking...</span>
            <span id="notificationStatus" style="display: none;" class="status-highlight">üîî Notifications ON</span>
        </div>

        <button id="toggleAudioBtn" class="btn btn-audio" style="margin-bottom: 20px;">
            <span id="audioIcon">üîä</span>
            <span id="audioText">Audio Narration ON</span>
        </button>

        <div id="progressSection" style="display: none;" class="progress-container">
            <div class="progress-header">
                <span>Next Story Segment</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px; text-align: center; margin-top: 10px;">
                <span id="distanceToNext">0.500 miles to next segment</span>
            </div>
        </div>

        <div class="buttons">
            <button id="startBtn" class="btn btn-start">
                ‚ñ∂Ô∏è Start Running
            </button>
            <button id="pauseBtn" class="btn btn-pause" style="display: none;">
                ‚è∏Ô∏è Pause
            </button>
            <button id="resetBtn" class="btn btn-reset">
                üîÑ Reset
            </button>
        </div>

        <div id="generatingIndicator" style="display: none;" class="generating">
            ‚ú® Generating your story segment...
        </div>
    </div>

    <div id="storyContainer"></div>
</div>

<script>
    // State variables
    let state = {
        genre: '',
        isTracking: false,
        distance: 0,
        speed: 0,
        storySegments: [],
        isGenerating: false,
        lastStoryDistance: 0,
        hasStarted: false,
        isTTSEnabled: true,
        isSpeaking: false,
        notificationsEnabled: false,
        watchId: null,
        lastPosition: null,
        lastTime: null,
        speedHistory: [],
        currentAudio: null
    };

    // Initialize Puter
    puter.ai = puter.ai || {};

    // DOM Elements
    const genreSelect = document.getElementById('genreSelect');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const toggleAudioBtn = document.getElementById('toggleAudioBtn');
    const enableNotificationsBtn = document.getElementById('enableNotificationsBtn');
    const distanceDisplay = document.getElementById('distanceDisplay');
    const speedDisplay = document.getElementById('speedDisplay');
    const gpsStatus = document.getElementById('gpsStatus');
    const progressSection = document.getElementById('progressSection');
    const progressFill = document.getElementById('progressFill');
    const progressPercent = document.getElementById('progressPercent');
    const distanceToNext = document.getElementById('distanceToNext');
    const generatingIndicator = document.getElementById('generatingIndicator');
    const storyContainer = document.getElementById('storyContainer');
    const setupSection = document.getElementById('setupSection');
    const speakingStatus = document.getElementById('speakingStatus');
    const notificationStatus = document.getElementById('notificationStatus');
    const locationIcon = document.getElementById('locationIcon');
    const notificationIcon = document.getElementById('notificationIcon');

    // Check permissions on load
    checkNotificationPermission();

    function checkNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'granted') {
            state.notificationsEnabled = true;
            notificationStatus.style.display = 'inline';
            notificationIcon.textContent = '‚úÖ';
            enableNotificationsBtn.style.display = 'none';
        }
    }

    // Request notification permission
    enableNotificationsBtn.addEventListener('click', async () => {
        if ('Notification' in window) {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                state.notificationsEnabled = true;
                notificationStatus.style.display = 'inline';
                notificationIcon.textContent = '‚úÖ';
                enableNotificationsBtn.style.display = 'none';
                new Notification('üéâ Notifications Enabled!', {
                    body: 'You\'ll be notified when new story segments are ready.',
                    icon: 'üìö'
                });
            }
        }
    });

    // Calculate distance between two GPS points
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 3958.8; // Earth's radius in miles
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Handle position update
    function handlePositionUpdate(position) {
        const currentTime = Date.now();
        const currentLat = position.coords.latitude;
        const currentLon = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        gpsStatus.textContent = `GPS Active (¬±${accuracy.toFixed(0)}m)`;

        if (state.lastPosition && state.lastTime) {
            const dist = calculateDistance(
                state.lastPosition.lat,
                state.lastPosition.lon,
                currentLat,
                currentLon
            );

            const timeDiffHours = (currentTime - state.lastTime) / 1000 / 3600;

            if (dist > 0.001 && dist < 0.5 && timeDiffHours > 0) {
                state.distance += dist;
                distanceDisplay.textContent = state.distance.toFixed(3) + ' mi';

                const currentSpeed = dist / timeDiffHours;
                if (currentSpeed > 0 && currentSpeed < 25) {
                    state.speedHistory.push(currentSpeed);
                    if (state.speedHistory.length > 10) {
                        state.speedHistory.shift();
                    }

                    const avgSpeed = state.speedHistory.reduce((a, b) => a + b, 0) / state.speedHistory.length;
                    state.speed = avgSpeed;
                    speedDisplay.textContent = avgSpeed.toFixed(1) + ' mph';
                }

                updateProgress();
                checkForNewSegment();
            }
        }

        state.lastPosition = { lat: currentLat, lon: currentLon };
        state.lastTime = currentTime;
    }

    // Update progress bar
    function updateProgress() {
        const distanceSinceLastStory = state.distance - state.lastStoryDistance;
        const progress = (distanceSinceLastStory / 0.5) * 100;
        progressFill.style.width = Math.min(progress, 100) + '%';
        progressPercent.textContent = Math.floor(progress) + '%';
        distanceToNext.textContent = (0.5 - distanceSinceLastStory).toFixed(3) + ' miles to next segment';
    }

    // Check if new segment should be generated
    function checkForNewSegment() {
        const distanceSinceLastStory = state.distance - state.lastStoryDistance;
        if (state.isTracking && distanceSinceLastStory >= 0.5 && !state.isGenerating) {
            const segmentNumber = Math.floor(state.distance / 0.5);
            const avgSpeed = state.speedHistory.length > 0
                ? state.speedHistory.reduce((a, b) => a + b, 0) / state.speedHistory.length
                : 3;
            generateStorySegment(segmentNumber, avgSpeed);
            state.lastStoryDistance = state.distance;
        }
    }

    // Generate story segment using Puter AI
    async function generateStorySegment(segmentNumber, avgSpeed) {
        state.isGenerating = true;
        generatingIndicator.style.display = 'block';

        const paceDescription = avgSpeed > 4 ? 'fast-paced and intense' :
                               avgSpeed > 3 ? 'moderate tension' :
                               'reflective and atmospheric';

        const prompt = `You are writing segment ${segmentNumber} of an ongoing ${state.genre} story. This is a story for a runner, and they've been running at ${avgSpeed.toFixed(1)} mph, so make this segment ${paceDescription}.
```

${segmentNumber === 1 ?
`This is the BEGINNING of the story. Introduce the main character and setting in an engaging way. End with a hook that makes them want to keep running for the next part. Write 3-4 paragraphs.` :
`This is segment ${segmentNumber}. Continue the story with rising action. Reference what happened before naturally. End with a cliffhanger or exciting moment. Write 3-4 paragraphs.

Previous segments summary: ${state.storySegments.slice(-2).map(s => s.text.slice(0, 100)).join(‚Äô ‚Ä¶ ‚Äô)}`
}

Write ONLY the story segment, no meta-commentary. Make it exciting and match the running pace!`;

```
        try {
            const response = await fetch('https://api.puter.com/drivers/call', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    interface: 'puter-chat-completion',
                    driver: 'openai',
                    method: 'complete',
                    args: {
                        messages: [
                            { role: 'user', content: prompt }
                        ]
                    }
                })
            });

            const data = await response.json();
            const storyText = data.message.content;

            const newSegment = {
                segment: segmentNumber,
                text: storyText,
                speed: avgSpeed,
                timestamp: new Date().toLocaleTimeString()
            };

            state.storySegments.push(newSegment);
            displayStorySegment(newSegment);

            // Send notification
            if (state.notificationsEnabled && 'Notification' in window) {
                const preview = storyText.slice(0, 100) + '...';
                new Notification(`üìñ Story Segment ${segmentNumber} Ready!`, {
                    body: preview,
                    icon: 'üìö',
                    vibrate: [200, 100, 200],
                    tag: 'story-segment'
                });
            }

            // Auto-play TTS if enabled
            if (state.isTTSEnabled && state.isTracking) {
                speakText(storyText);
            }
        } catch (error) {
            console.error('Error generating story:', error);
            const errorSegment = {
                segment: segmentNumber,
                text: 'Connection error. Keep running, the story will continue when reconnected!',
                speed: avgSpeed,
                timestamp: new Date().toLocaleTimeString()
            };
            state.storySegments.push(errorSegment);
            displayStorySegment(errorSegment);
        }

        state.isGenerating = false;
        generatingIndicator.style.display = 'none';
    }

    // Speak text using Puter TTS
    async function speakText(text) {
        if (state.currentAudio) {
            state.currentAudio.pause();
            state.currentAudio = null;
        }

        try {
            state.isSpeaking = true;
            speakingStatus.style.display = 'inline';

            const response = await fetch('https://api.puter.com/drivers/call', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    interface: 'puter-tts',
                    driver: 'openai',
                    method: 'speak',
                    args: {
                        text: text,
                        voice: 'alloy'
                    }
                })
            });

            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);

            const audio = new Audio(audioUrl);
            state.currentAudio = audio;

            audio.onended = () => {
                state.isSpeaking = false;
                speakingStatus.style.display = 'none';
                URL.revokeObjectURL(audioUrl);
                state.currentAudio = null;
            };

            audio.onerror = () => {
                state.isSpeaking = false;
                speakingStatus.style.display = 'none';
                URL.revokeObjectURL(audioUrl);
                state.currentAudio = null;
            };

            await audio.play();
        } catch (error) {
            console.error('TTS Error:', error);
            state.isSpeaking = false;
            speakingStatus.style.display = 'none';
        }
    }

    // Display story segment
    function displayStorySegment(segment) {
        const segmentDiv = document.createElement('div');
        segmentDiv.className = 'card';
        segmentDiv.innerHTML = `
            <div class="story-segment">
                <div class="segment-header">
                    <span class="segment-title">Segment ${segment.segment}</span>
                    <div class="segment-meta">
                        <button class="speaker-btn" onclick="speakText(\`${segment.text.replace(/`/g, '\\`')}\`)">üîä</button>
                        <span>${segment.speed.toFixed(1)} mph ‚Ä¢ ${segment.timestamp}</span>
                    </div>
                </div>
                <div class="segment-text">${segment.text}</div>
            </div>
        `;
        storyContainer.appendChild(segmentDiv);
        segmentDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    // Start tracking
    startBtn.addEventListener('click', () => {
        const genre = genreSelect.value;
        if (!genre) {
            alert('Please select a genre first!');
            return;
        }

        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
            return;
        }

        state.genre = genre;
        state.hasStarted = true;
        state.isTracking = true;
        setupSection.style.display = 'none';
        progressSection.style.display = 'block';
        startBtn.style.display = 'none';
        pauseBtn.style.display = 'block';
        gpsStatus.textContent = 'Requesting location permission...';
        state.lastTime = Date.now();

        // Request notification permission if not granted
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    state.notificationsEnabled = true;
                    notificationStatus.style.display = 'inline';
                }
            });
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                state.lastPosition = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                };
                state.lastTime = Date.now();
                gpsStatus.textContent = 'GPS Locked';
                locationIcon.textContent = '‚úÖ';

                state.watchId = navigator.geolocation.watchPosition(
                    handlePositionUpdate,
                    (error) => {
                        console.error('GPS Error:', error);
                        gpsStatus.textContent = 'GPS Error - ' + error.message;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            },
            (error) => {
                console.error('GPS Error:', error);
                gpsStatus.textContent = 'Location permission denied';
                alert('Please enable location permissions to track your run.');
                state.isTracking = false;
                state.hasStarted = false;
                startBtn.style.display = 'block';
                pauseBtn.style.display = 'none';
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    });

    // Pause tracking
    pauseBtn.addEventListener('click', () => {
        state.isTracking = false;
        gpsStatus.textContent = 'Paused';
        if (state.watchId) {
            navigator.geolocation.clearWatch(state.watchId);
            state.watchId = null;
        }
        if (state.currentAudio) {
            state.currentAudio.pause();
            state.currentAudio = null;
            state.isSpeaking = false;
            speakingStatus.style.display = 'none';
        }
        startBtn.style.display = 'block';
        pauseBtn.style.display = 'none';
        startBtn.innerHTML = '‚ñ∂Ô∏è Resume';
    });

    // Reset
    resetBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to reset? This will clear your current run and story.')) {
            if (state.watchId) {
                navigator.geolocation.clearWatch(state.watchId);
            }
            if (state.currentAudio) {
                state.currentAudio.pause();
            }
            state = {
                ...state,
                isTracking: false,
                distance: 0,
                speed: 0,
                storySegments: [],
                isGenerating: false,
                lastStoryDistance: 0,
                hasStarted: false,
                watchId: null,
                lastPosition: null,
                lastTime: null,
                speedHistory: [],
                currentAudio: null,
                isSpeaking: false
            };
            distanceDisplay.textContent = '0.000 mi';
            speedDisplay.textContent = '0.0 mph';
            gpsStatus.textContent = 'Ready';
            setupSection.style.display = 'block';
            progressSection.style.display = 'none';
            startBtn.style.display = 'block';
            pauseBtn.style.display = 'none';
            startBtn.innerHTML = '‚ñ∂Ô∏è Start Running';
            storyContainer.innerHTML = '';
            speakingStatus.style.display = 'none';
            locationIcon.textContent = 'üìç';
        }
    });

    // Toggle audio
    toggleAudioBtn.addEventListener('click', () => {
        state.isTTSEnabled = !state.isTTSEnabled;
        if (state.isTTSEnabled) {
            document.getElementById('audioIcon').textContent = 'üîä';
            document.getElementById('audioText').textContent = 'Audio Narration ON';
            toggleAudioBtn.style.background = 'rgba(16, 185, 129, 0.3)';
        } else {
            document.getElementById('audioIcon').textContent = 'üîá';
            document.getElementById('audioText').textContent = 'Audio Narration OFF';
            toggleAudioBtn.style.background = 'rgba(239, 68, 68, 0.3)';
            if (state.currentAudio) {
                state.currentAudio.pause();
                state.currentAudio = null;
                state.isSpeaking = false;
                speakingStatus.style.display = 'none';
            }
        }
    });
</script>
```

</body>
</html>