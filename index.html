<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Story Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div id="root"></div>
    <script type="module" type="text/babel">
        import React, { useState, useEffect, useRef } from 'react';
        import { Play, Pause, RotateCcw, Book, Volume2, VolumeX, Bell, BellOff } from 'lucide-react';

        export default function RunningStoryApp() {
            const [genre, setGenre] = useState('');
            const [isTracking, setIsTracking] = useState(false);
            const [distance, setDistance] = useState(0);
            const [speed, setSpeed] = useState(0);
            const [storySegments, setStorySegments] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            const [lastStoryDistance, setLastStoryDistance] = useState(0);
            const [hasStarted, setHasStarted] = useState(false);
            const [gpsStatus, setGpsStatus] = useState('Ready');
            const [isTTSEnabled, setIsTTSEnabled] = useState(true);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [notificationsEnabled, setNotificationsEnabled] = useState(false);

            const watchIdRef = useRef(null);
            const lastPositionRef = useRef(null);
            const lastTimeRef = useRef(null);
            const totalDistanceRef = useRef(0);
            const speedHistoryRef = useRef([]);
            const currentAudioRef = useRef(null);

            const genres = [
                'Fantasy Adventure',
                'Sci-Fi Thriller',
                'Mystery Detective',
                'Horror Survival',
                'Romance Comedy',
                'Historical Fiction',
                'Superhero Action',
                'Dystopian Future'
            ];

            useEffect(() => {
                if ('Notification' in window) {
                    setNotificationsEnabled(Notification.permission === 'granted');
                }
            }, []);

            const requestNotificationPermission = async () => {
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    setNotificationsEnabled(permission === 'granted');
                    if (permission === 'granted') {
                        new Notification('ðŸŽ‰ Notifications Enabled!', {
                            body: 'You\'ll be notified when new story segments are ready.',
                        });
                    }
                } else {
                    alert('Notifications are not supported in this browser');
                }
            };

            const generateStorySegment = async (segmentNumber, avgSpeed) => {
                setIsGenerating(true);

                const paceDescription = avgSpeed > 4 ? 'fast-paced and intense' :
                    avgSpeed > 3 ? 'moderate tension' :
                        'reflective and atmospheric';

                const prompt = `You are writing segment ${segmentNumber} of an ongoing ${genre} story. This is a story for a runner, and they've been running at ${avgSpeed.toFixed(1)} mph, so make this segment ${paceDescription}.

${segmentNumber === 1 ?
                        `This is the BEGINNING of the story. Introduce the main character and setting in an engaging way. End with a hook that makes them want to keep running for the next part. Write 3-4 paragraphs.` :
                        `This is segment ${segmentNumber}. Continue the story with rising action. Reference what happened before naturally. End with a cliffhanger or exciting moment. Write 3-4 paragraphs.

Previous segments summary: ${storySegments.slice(-2).map(s => s.text.slice(0, 100)).join(' ... ')}`
                    }

Write ONLY the story segment, no meta-commentary. Make it exciting and match the running pace!`;

                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 1000,
                            messages: [
                                { role: "user", content: prompt }
                            ]
                        })
                    });

                    const data = await response.json();
                    const storyText = data.content[0].text;

                    const newSegment = {
                        segment: segmentNumber,
                        text: storyText,
                        speed: avgSpeed,
                        timestamp: new Date().toLocaleTimeString()
                    };

                    setStorySegments(prev => [...prev, newSegment]);

                    // Send notification
                    if (notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
                        const preview = storyText.slice(0, 100) + '...';
                        new Notification(`ðŸ“– Story Segment ${segmentNumber} Ready!`, {
                            body: preview,
                            vibrate: [200, 100, 200],
                            tag: 'story-segment'
                        });
                    }

                    // Auto-play TTS if enabled and tracking
                    if (isTTSEnabled && isTracking) {
                        speakText(storyText);
                    }
                } catch (error) {
                    console.error("Error generating story:", error);
                    const errorSegment = {
                        segment: segmentNumber,
                        text: "Connection error. Keep running, the story will continue when reconnected!",
                        speed: avgSpeed,
                        timestamp: new Date().toLocaleTimeString()
                    };
                    setStorySegments(prev => [...prev, errorSegment]);

                    if (isTTSEnabled && isTracking) {
                        speakText(errorSegment.text);
                    }
                }

                setIsGenerating(false);
            };

            const speakText = async (text) => {
                if (currentAudioRef.current) {
                    currentAudioRef.current.pause();
                    currentAudioRef.current = null;
                }

                try {
                    setIsSpeaking(true);

                    const response = await fetch('https://api.puter.com/drivers/call', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            interface: 'puter-tts',
                            driver: 'openai',
                            method: 'speak',
                            args: {
                                text: text,
                                voice: 'alloy'
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error('TTS request failed');
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);

                    const audio = new Audio(audioUrl);
                    currentAudioRef.current = audio;

                    audio.onended = () => {
                        setIsSpeaking(false);
                        URL.revokeObjectURL(audioUrl);
                        currentAudioRef.current = null;
                    };

                    audio.onerror = () => {
                        setIsSpeaking(false);
                        URL.revokeObjectURL(audioUrl);
                        currentAudioRef.current = null;
                    };

                    await audio.play();
                } catch (error) {
                    console.error('TTS Error:', error);
                    setIsSpeaking(false);
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.9;
                    utterance.onend = () => setIsSpeaking(false);
                    window.speechSynthesis.speak(utterance);
                }
            };

            const toggleTTS = () => {
                setIsTTSEnabled(!isTTSEnabled);
                if (currentAudioRef.current) {
                    currentAudioRef.current.pause();
                    currentAudioRef.current = null;
                    setIsSpeaking(false);
                }
            };

            const stopSpeaking = () => {
                if (currentAudioRef.current) {
                    currentAudioRef.current.pause();
                    currentAudioRef.current = null;
                    setIsSpeaking(false);
                }
            };

            const calculateDistance = (lat1, lon1, lat2, lon2) => {
                const R = 3958.8;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            };

            const handlePositionUpdate = (position) => {
                const currentTime = Date.now();
                const currentLat = position.coords.latitude;
                const currentLon = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                setGpsStatus(`GPS Active (Â±${accuracy.toFixed(0)}m)`);

                if (lastPositionRef.current && lastTimeRef.current) {
                    const dist = calculateDistance(
                        lastPositionRef.current.lat,
                        lastPositionRef.current.lon,
                        currentLat,
                        currentLon
                    );

                    const timeDiffHours = (currentTime - lastTimeRef.current) / 1000 / 3600;

                    if (dist > 0.001 && dist < 0.5 && timeDiffHours > 0) {
                        totalDistanceRef.current += dist;
                        setDistance(totalDistanceRef.current);

                        const currentSpeed = dist / timeDiffHours;
                        if (currentSpeed > 0 && currentSpeed < 25) {
                            speedHistoryRef.current.push(currentSpeed);
                            if (speedHistoryRef.current.length > 10) {
                                speedHistoryRef.current.shift();
                            }

                            const avgSpeed = speedHistoryRef.current.reduce((a, b) => a + b, 0) / speedHistoryRef.current.length;
                            setSpeed(avgSpeed);
                        }
                    }
                }

                lastPositionRef.current = { lat: currentLat, lon: currentLon };
                lastTimeRef.current = currentTime;
            };

            const handlePositionError = (error) => {
                console.error("GPS Error:", error);
                if (error.code === 1) {
                    setGpsStatus('Location permission denied');
                    alert('Please enable location permissions in your browser settings to track your run.');
                } else if (error.code === 2) {
                    setGpsStatus('GPS signal unavailable');
                } else if (error.code === 3) {
                    setGpsStatus('GPS timeout - trying again...');
                }
            };

            useEffect(() => {
                const distanceSinceLastStory = totalDistanceRef.current - lastStoryDistance;

                if (isTracking && distanceSinceLastStory >= 0.5 && !isGenerating) {
                    const segmentNumber = Math.floor(totalDistanceRef.current / 0.5);
                    const avgSpeed = speedHistoryRef.current.length > 0
                        ? speedHistoryRef.current.reduce((a, b) => a + b, 0) / speedHistoryRef.current.length
                        : 3;

                    generateStorySegment(segmentNumber, avgSpeed);
                    setLastStoryDistance(totalDistanceRef.current);
                }
            }, [distance, isTracking, isGenerating]);

            const startTracking = () => {
                if (!genre) {
                    alert('Please select a genre first!');
                    return;
                }

                if (!navigator.geolocation) {
                    alert('Geolocation is not supported by your browser');
                    return;
                }

                if ('Notification' in window && Notification.permission === 'default') {
                    requestNotificationPermission();
                }

                setHasStarted(true);
                setIsTracking(true);
                setGpsStatus('Requesting location permission...');
                lastTimeRef.current = Date.now();

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        lastPositionRef.current = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        lastTimeRef.current = Date.now();
                        setGpsStatus('GPS Locked');

                        watchIdRef.current = navigator.geolocation.watchPosition(
                            handlePositionUpdate,
                            handlePositionError,
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            }
                        );
                    },
                    (error) => {
                        handlePositionError(error);
                        setIsTracking(false);
                        setHasStarted(false);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            };

            const pauseTracking = () => {
                setIsTracking(false);
                setGpsStatus('Paused');
                stopSpeaking();
                if (watchIdRef.current !== null) {
                    navigator.geolocation.clearWatch(watchIdRef.current);
                    watchIdRef.current = null;
                }
            };

            const reset = () => {
                pauseTracking();
                stopSpeaking();
                setDistance(0);
                setSpeed(0);
                setStorySegments([]);
                setLastStoryDistance(0);
                setHasStarted(false);
                setGpsStatus('Ready');
                lastPositionRef.current = null;
                lastTimeRef.current = null;
                totalDistanceRef.current = 0;
                speedHistoryRef.current = [];
            };

            const progressToNextSegment = ((distance - lastStoryDistance) / 0.5) * 100;

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-800 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-6 mb-6">
                            <div className="flex items-center gap-3 mb-6">
                                <Book className="w-8 h-8 text-yellow-300" />
                                <h1 className="text-3xl font-bold text-white">Running Story Tracker</h1>
                            </div>

                            {!hasStarted && (
                                <div className="mb-6">
                                    <label className="block text-white text-sm font-semibold mb-2">
                                        Choose Your Story Genre:
                                    </label>
                                    <select
                                        value={genre}
                                        onChange={(e) => setGenre(e.target.value)}
                                        className="w-full p-3 rounded-lg bg-white/20 text-white border-2 border-white/30 focus:border-yellow-300 focus:outline-none"
                                    >
                                        <option value="">Select a genre...</option>
                                        {genres.map(g => (
                                            <option key={g} value={g} className="bg-purple-900">{g}</option>
                                        ))}
                                    </select>

                                    <div className="mt-4 p-4 bg-blue-500/20 rounded-lg border border-blue-300/30">
                                        <h3 className="text-white font-semibold mb-3">ðŸ“‹ Setup:</h3>
                                        <div className="space-y-3">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2 text-white/90">
                                                    {notificationsEnabled ? (
                                                        <Bell className="w-5 h-5 text-green-300" />
                                                    ) : (
                                                        <BellOff className="w-5 h-5 text-white/50" />
                                                    )}
                                                    <span>Story Notifications</span>
                                                </div>
                                                {!notificationsEnabled && (
                                                    <button
                                                        onClick={requestNotificationPermission}
                                                        className="bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded transition-colors"
                                                    >
                                                        Enable
                                                    </button>
                                                )}
                                                {notificationsEnabled && (
                                                    <span className="text-green-300 text-sm">âœ“ Enabled</span>
                                                )}
                                            </div>
                                            <p className="text-white/70 text-xs">
                                                Location permission will be requested when you start running
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div className="bg-white/20 rounded-lg p-4">
                                    <div className="text-white/70 text-sm">Distance</div>
                                    <div className="text-3xl font-bold text-white">{distance.toFixed(3)} mi</div>
                                </div>
                                <div className="bg-white/20 rounded-lg p-4">
                                    <div className="text-white/70 text-sm">Speed</div>
                                    <div className="text-3xl font-bold text-white">{speed.toFixed(1)} mph</div>
                                </div>
                            </div>

                            <div className="mb-4 text-center text-sm text-white/70">
                                Status: {gpsStatus}
                                {isSpeaking && <span className="ml-2 text-yellow-300">ðŸ”Š Speaking...</span>}
                            </div>

                            <div className="mb-6 flex justify-center">
                                <button
                                    onClick={toggleTTS}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-colors ${isTTSEnabled
                                            ? 'bg-green-500/30 text-green-300 hover:bg-green-500/40'
                                            : 'bg-red-500/30 text-red-300 hover:bg-red-500/40'
                                        }`}
                                >
                                    {isTTSEnabled ? <Volume2 className="w-5 h-5" /> : <VolumeX className="w-5 h-5" />}
                                    {isTTSEnabled ? 'Audio Narration ON' : 'Audio Narration OFF'}
                                </button>
                            </div>

                            {hasStarted && (
                                <div className="mb-6">
                                    <div className="flex justify-between text-white text-sm mb-2">
                                        <span>Next Story Segment</span>
                                        <span>{progressToNextSegment.toFixed(0)}%</span>
                                    </div>
                                    <div className="w-full bg-white/20 rounded-full h-4">
                                        <div
                                            className="bg-gradient-to-r from-yellow-300 to-pink-400 h-4 rounded-full transition-all duration-500"
                                            style={{ width: `${Math.min(progressToNextSegment, 100)}%` }}
                                        />
                                    </div>
                                    <div className="text-white/60 text-xs text-center mt-2">
                                        {(0.5 - (distance - lastStoryDistance)).toFixed(3)} miles to next segment
                                    </div>
                                </div>
                            )}

                            <div className="flex gap-3">
                                {!isTracking ? (
                                    <button
                                        onClick={startTracking}
                                        className="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors"
                                    >
                                        <Play className="w-5 h-5" />
                                        {hasStarted ? 'Resume' : 'Start Running'}
                                    </button>
                                ) : (
                                    <button
                                        onClick={pauseTracking}
                                        className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors"
                                    >
                                        <Pause className="w-5 h-5" />
                                        Pause
                                    </button>
                                )}
                                <button
                                    onClick={reset}
                                    className="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors"
                                >
                                    <RotateCcw className="w-5 h-5" />
                                    Reset
                                </button>
                            </div>

                            {isGenerating && (
                                <div className="mt-4 text-center text-yellow-300 animate-pulse">
                                    âœ¨ Generating your story segment...
                                </div>
                            )}
                        </div>

                        {storySegments.length > 0 && (
                            <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-6">
                                <h2 className="text-2xl font-bold text-white mb-4">Your {genre} Story</h2>
                                <div className="space-y-6">
                                    {storySegments.map((segment, idx) => (
                                        <div key={idx} className="bg-white/20 rounded-lg p-4">
                                            <div className="flex justify-between items-center mb-3">
                                                <span className="text-yellow-300 font-bold">Segment {segment.segment}</span>
                                                <div className="flex items-center gap-3">
                                                    <button
                                                        onClick={() => speakText(segment.text)}
                                                        className="text-white/70 hover:text-white transition-colors"
                                                        title="Play audio"
                                                    >
                                                        <Volume2 className="w-4 h-4" />
                                                    </button>
                                                    <span className="text-white/70 text-sm">
                                                        {segment.speed.toFixed(1)} mph â€¢ {segment.timestamp}
                                                    </span>
                                                </div>
                                            </div>
                                            <p className="text-white whitespace-pre-line leading-relaxed">
                                                {segment.text}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RunningStoryApp />);
    </script>
</body>

</html>